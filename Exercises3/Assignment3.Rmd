---
title: "Exercises Topic 5 and &"
subtitle: "Lifetime Data Analysis - Autumn 2021"
author: "Alexander and Ulrik"
date: "`r format(Sys.time(), '%d %B, %Y')`"
params: 
  show_code: FALSE
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    theme: readable
    highlight: textmate
    number_sections: false
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = params$show_code, warning = F)
#setwd("/home/ajo/gitRepos/lifetime/Exercises3")
rm(list = ls())
library(KMsurv)
library(rms)
library(survival)
library(FHtest)
library(GofCens)
```

# Exercise 1
The data frame $\textbf{tongue}$ of the R package $\textbf{KMsurv}$ contains the survival times (in weeks) of 80 patients with oral cancer. The objective of this exercise is to study the possible relation of this cancer with the tumour DNA profile, which is either aneuploid or diploid.

```{r, results = "hide"}
data(tongue)
head(tongue)
str(tongue)
```


## 1.a)

The survival curves are plotted below. Observe that the survival of the aneuploid tumour is greater than the survival of the diploid tumour.  
As the survival curves do not go to zero there is right censoring in both groups.

```{r}
# a) Draw the survival curves. 
s <- with(tongue, Surv(time, delta))
t <- npsurv(s ~ type, tongue)

par(font = 2, font.axis = 2, font.lab = 4, las = 1, mar = c(5, 5, 4, 2))
survplot(t, ylab = expression(bold(hat(S)(t))), col = 1:2, lwd = 3, conf = "none")
title("Survival functions according to tumour DNA profile")
```

## 1.b) 

The logrank test is used to test the hypothesis that survival is not related to tumour type. The hypothesis that is tested can be formulated as 
$$
\begin{equation}
        H_0: S_1(t) = S_2(t) \text{ vs. } H_1: S_1(t) \neq S_2(t),
\end{equation}
$$
    
where $S_1(t)$ and $S_2(t)$ refer to the survival curves of tumour type 1 and 2 respectively. 
    
The result from the logrank test is a $Z$-value of 1.7 and a $p$-value of $0.0949$, which means that we would conclude not to reject $H_0$ when choosing any reasonable significance level for the $p$-value. This means that, according to the logrank test, there is not enough evidence to conclude that the tumour DNA profile is related to the survival of the cancer patients, i.e. one does not conclude that one of the tumour profile leads to more severe cancer. 

```{r}
# b) Logrank test. 
s2 <- with(tongue, Surv(time, delta) ~ type)
FHtestrcc(s2)
```

## 1.c)

The log-logistic regression model is fitted with the single covariate 'Tumour type'. This model is used to test the same hypothesis as in \textbf{b)}. In this case, the null and alternative hypothesis can be formulated as 
$$
  H_0: \gamma_1 = 0 \text{ vs. } H_1 : \gamma_1 \neq 0,
$$
where $\gamma_1$ is the covariate coefficent for tumour DNA profile in the model.
The regression gives $\gamma_1 = -0.79$ with $p$-value 0.051, which 
gives significant evidence to reject the null hypothesis. 
I.e., the test suggests that DNA profile has an impact on the survival time of
cancer patients.

```{r}
# c) Fit log-logistic model and use the model to test the same hypothesis. 
loglogistic <- survreg(s ~ type, data = tongue, dist = "loglogistic")
summary(loglogistic)
```

## 1.d)
Since the log-logistic model can be viewed as a proportional odds model,
the odds ratio $\exp \{ \boldsymbol{\beta'Z} \} = \exp \{ -\boldsymbol{\gamma'Z}/\sigma \}$
indicates how the odds to survive change with respect to covariates $\textbf{Z}$
compared to $\textbf{Z = 0}$.
For this model a patient with DNA profile diploid has a survival odds 2.28
times higher than a patient with DNA profile aneuploid.

Similarly, the accelerated factor $\exp \{ \boldsymbol{-\gamma'Z} \}$ 
describes the change in time scale compared to the baseline 
$\textbf{Z = 0}$. (Not quite sure what this means)?
Since the scale parameter is close to one, the accelerated factor is  close
to the odds ratio, specifically 2.205.

```{r}
with(loglogistic, exp(-coefficients[2] / scale))  # Odds ratio
with(loglogistic, exp(-coefficients[2]))  # Accelerated factor
```


## 1.e) 

The residuals of the log-logistic regression model are plotted below. As one can see, the standard logistic distribution seems to fit the residual KM-estimate well \textcolor{red}{Omformuler dette litt}, which can be used as an indication that the log-logistic model is appropriate for this data. 

```{r}
loglo.pred <- predict(loglogistic, type = "linear")
resids.loglo <- (log(tongue$time) - loglo.pred) / loglogistic$scale

par(font = 2, font.axis = 2, font.lab = 2, las = 1, mar = c(5, 5, 4, 2))
plot(survfit(Surv(resids.loglo, tongue$delta) ~ 1), col = c(1,2,2), xlab = "Residuals",
     ylab = expression(bolditalic(hat(S)(t))),
     lty = 1, lwd = 3, yaxs = "i", xaxs = "i", bty = "n")
title("Residuals of the log-logistic Regression Model")
curve(plogis(x, lower.tail = F), from = min(resids.loglo), to = max(resids.loglo), col = 3, lwd = 3,
      add = TRUE)
legend("bottomleft", c("KM estimate", "95% - CI", "Stand. Logistic Distribution"),
       col = c(1, 2, 3), lty = c(1, 2, 1), lwd = 3, bty = "n")
```

# Exercise 2

Following, we will generate survival times from a log-normal distribution and check whether the Weibull or the log-logistic distribution fit better to the data. 

## 2.a)

300 survival times from a log-normal distribution with parameters $\mu = 2$ and $\sigma = 1$ are generated below. 

```{r, echo = T}
set.seed(1)
mu <- 2
sigma <- 1
location <- log(mu^2 / sqrt(sigma^2 + mu^2))
shape <- sqrt(log(1 + (sigma^2 / mu^2)))
RVT <- rlnorm(3000, meanlog = location, shape)
# https://en.wikipedia.org/wiki/Log-normal_distribution#Arithmetic_moments
# https://msalganik.wordpress.com/2017/01/21/making-sense-of-the-rlnorm-function-in-r/
```


## 2.b) 

300 censoring times from an exponential distribution with mean 20 are generated below. 

```{r, echo = T}
RVC <- rexp(300, rate = 1/20)
```

## 2.c)

The variables $Y = \min(T, C)$ and $\delta = \mathbf{1}_{T\leq C}$ are created below. The table below shows the counts of exact failure times and censoring times.

```{r, echo = T}
obs <- pmin(RVT, RVC)
cens <- as.numeric(RVT <= RVC)
(tab <- table(cens))
```

The proportion of right-censored survival times is thus `r round(tab[[1]]/tab[[2]], 3)`.

## 2.d)

The cumulative hazard plots for the Weibull and the log-logistic distributions are plotted below. It looks like the log-logistic distribution fits the data better than the Weibull model, since the latter is clearly a bad fit. 

```{r, results="hide"}
cumhazPlot(obs, cens, col = 4, distr = c("wei", "loglo"), ggplo = T)
```

# Exercise 3

Assume that the model assumptions for the Cox proportional hazards model holds for a continuous survival time $T$ with covariates $\textbf{Z} = (Z_1, \ldots, Z_p)'$, i.e., that,
$$
\begin{equation*}
        \lambda(t; \textbf{z}) = \lambda_0(t) \exp (\boldsymbol{\beta'z}), 
\end{equation*}
$$
but that the survival times are grouped in the intervals $[0 = a_0, a_1), \ldots, [a_{g-1}, a_g)$.
The corresponding hazards are defined as 
$$
\begin{equation*}
        \lambda_j(\textbf{z}) = P(T < a_j |T \geq a_{j-1}; \textbf{z}), \ j = 1, \ldots, g.
\end{equation*}
$$
Then we can write 
$$
\begin{align*}
        1 - \lambda_j(\textbf{z}) &= P(T \geq a_j | T \geq a_{j-1}; \textbf{z}) \\
                                  &= \frac{P(T \geq a_j, T \geq a_{j-1} ; \textbf{z})}{P(T \geq a_{j-1}; \textbf{z})} \\
                                  &= \frac{P(T \geq a_j; \textbf{z})}{P(T \geq a_{j-1}; \textbf{z})}.
\end{align*}
$$
First we observe that 
$$
\begin{align*}
        P(T \geq a_j ; \textbf{z}) &= S_\textbf{z}(a_j) \\\
                                   &= \exp (- \Lambda_\textbf{z}(a_j)) \\
                                   &= \exp (-(\int_{a_0}^{a_1}\lambda_0(t)\exp (\boldsymbol{\beta'z}dt + \ldots + \int_{a_{j-1}}^{a_j}\lambda_0(t)\exp(\boldsymbol{\beta'z}dt)))) \\
                                   &= \exp (-(\int_{a_0}^{a_1}\lambda_0(t)dt + \ldots + \int_{a_{j-1}}^{a_j}\lambda_0(t)dt)\exp (\boldsymbol{\beta'z})) \\
                                   &= \left( \exp(-\Lambda_\textbf{0}(a_j)) \right)^{\exp (\boldsymbol{\beta'z})} \\
                                   &= (P(T \geq a_j ; \textbf{0}))^{\exp (\boldsymbol{\beta'z})}.
\end{align*}
$$
The exact same argument for $P(T \geq a_{j-1} ; \textbf{z})$ gives us 
$$
\begin{align*}
        1 - \lambda_j(\textbf{z}) &= \left( \frac{P(T \geq a_j; \textbf{0})}{P(T \geq a_{j-1}; \textbf{0})} \right)^{\exp (\boldsymbol{\beta'z})} \\
                                  &= (1 - \lambda_j(\textbf{0}))^{\exp (\boldsymbol{\beta'z})}
\end{align*}
$$
or equivalently
$$
\begin{equation*}
        \log (1 - \lambda_j(\textbf{z})) = (1 - \lambda_j) \exp (\boldsymbol{\beta'z}).
\end{equation*}
$$

# Exercise 4

The data frame $\textbf{hodg}$ of the $\textbf{KMsurv}$ package contains the times until relapse or death of 43 lymphoma patients that underwent a bone marrow transplant. 

## 4.a)

The variables **gtype** and **dtype** are turned into factors. 

```{r}
data(hodg)
str(hodg)
hodg$gtype <- as.factor(hodg$gtype)
hodg$dtype <- as.factor(hodg$dtype)
```

## 4.b

Survival curves corresponding to the four combinations of graft and disease types are plotted below. 

```{r}
srem <- with(hodg, Surv(time, delta))
svf <- survfit(srem ~ gtype + dtype, data = hodg)

par(las = 1, font = 2, font.axis = 2, font.lab = 4, xaxs = "i", yaxs = "i",
    mar = c(5, 5, 4, 2), bty = "l", cex.lab = 1.5, cex.axis = 1.25)
plot(svf, conf.int = F, lwd = 2, col = 1:4, lty = 1:4, xlab = "Time to death or relapse [days]",
     ylab = expression(bolditalic(hat(S)(t))), ylim = c(0,1))
axis(1, at = seq(0, 2000, 250))
axis(2, at = seq(0, 1, 0.1))
title("Survival Functions of All Combinations of Graft and Disease Types")
legend("bottomright", legend = levels(hodg$gtype:hodg$gtype),
       col = 1:4, lty = 1:4, lwd = 2, bty = "n")
```

The leftmost number in the legend is **gtype** and the rightmost number is **dtype**. COULD IMPROVE HOW THE LEGEND LOOKS LATER! Perhaps also change the xlim. 

It looks like the different combinations of graft and disease types yield significantly different survival times. When looking at longevity, the combination of allogenic graft type and Non Hodgkin lymphoma yields the largest survival (1:1), followed by autologous graft type and Hodgkins disease (2:2). The combination of allogenic graft type and Hodgkins disease (1:2) seams to yield very low survival. However, not that this combination has far fewer events than the other combinations in the data set (5, compared to 11, 12 and 15). 
CLEAN THIS UP A BIT. 

## 4.c)

Fit the proportional hazards model that includes graft type, disease type, the interaction of both and the Karnofsky index.   

```{r}
<<<<<<< HEAD
cox.mod <- coxph(srem ~ gtype + dtype + gtype:dtype + score, data = hodg)
summary(cox.mod)
```

=======
proph <- coxph(srem ~ gtype + dtype + gtype:dtype + score, data = hodg)
summary(proph)
```

## 4.d)


>>>>>>> add40a7232a5f259de44efe4c06dc3c636ff3223
